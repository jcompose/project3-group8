<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real Estate Map Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/lumen/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #map { height: 600px; }
        .filter-container { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-5 text-center font-weight-bold">Real Estate Map Dashboard</h1>
        <!-- Filter inputs for city and price range -->
        <div class="filter-container">
            <label for="city-filter">City:</label>
            <input type="text" id="city-filter" placeholder="Enter city name" class="form-control">
            <label for="min-price-filter">Min Price:</label>
            <input type="number" id="min-price-filter" placeholder="Min price" class="form-control">
            <label for="max-price-filter">Max Price:</label>
            <input type="number" id="max-price-filter" placeholder="Max price" class="form-control">
            <button onclick="applyFilters()" class="btn btn-primary mt-2">Apply Filters</button>
        </div>
        <div id="map"></div>
    </div>
    <script>
        // Set initial map view to center of the USA
        const map = L.map('map').setView([39.8283, 98.5795], 4);
        // Add OpenStreetMap tiles to the map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Clustering property markers for better performance (it is SO BAD without it trust me)
        const markers = L.markerClusterGroup();

        function fetchData(page = 1, limit = 100, city = '', minPrice = '', maxPrice = '') {
            let url = `/api/real_estate/map?page=${page}&limit=${limit}`;
            if (city) url += `&city=${city}`;
            if (minPrice) url += `&min_price=${minPrice}`;
            if (maxPrice) url += `&max_price=${maxPrice}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    data.forEach(d => {
                        const marker = L.marker([d.latitude, d.longitude])
                            .bindPopup(`City: ${d.city}<br>Price: ${d.price}<br>Bedrooms: ${d.bedrooms}<br>Bathrooms: ${d.bathrooms}<br>Year Built: ${d.yearBuilt}<br>Home Type: ${d.homeType}`);
                        markers.addLayer(marker);
                    });
                    map.addLayer(markers);

                    // Fetch more data when ready
                    if (data.length === limit) {
                        fetchData(page + 1, limit, city, minPrice, maxPrice);
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function applyFilters() {
            const city = document.getElementById('city-filter').value;
            const minPrice = document.getElementById('min-price-filter').value;
            const maxPrice = document.getElementById('max-price-filter').value;
            markers.clearLayers();
            fetchData(1, 100, city, minPrice, maxPrice);
        }

        // Initial data fetch
        fetchData();
    </script>
</body>
</html>
